name: Build and Deploy to Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: dengue-forecasting-486221
  REGION: europe-west6
  REPO: dengue-repo
  IMAGE: dengue-pipeline
  JOB: dengue-pipeline-job
  SCHEDULER_JOB: dengue-pipeline-daily
  TIME_ZONE: Europe/Zurich
  MLFLOW_TRACKING_URI: https://mlflow-277673542073.europe-west6.run.app
  SCHEDULER_SA: github-deployer@dengue-forecasting-486221.iam.gserviceaccount.com

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: projects/277673542073/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@dengue-forecasting-486221.iam.gserviceaccount.com

      - name: Configure gcloud
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker auth
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev

      - name: Build
        run: docker build -f Intellishore/Dockerfile -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${GITHUB_SHA} Intellishore

      - name: Push
        run: docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${GITHUB_SHA}

      - name: Deploy Cloud Run Job (pipeline)
        run: |
          set -euo pipefail
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${GITHUB_SHA}"

          if gcloud run jobs describe "${JOB}" --region "${REGION}" >/dev/null 2>&1; then
            gcloud run jobs update "${JOB}" \
              --image "${IMAGE_URI}" \
              --region "${REGION}" \
              --set-env-vars "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" \
              --command python \
              --args -m,src.main
          else
            gcloud run jobs create "${JOB}" \
              --image "${IMAGE_URI}" \
              --region "${REGION}" \
              --set-env-vars "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" \
              --command python \
              --args -m,src.main
          fi

      - name: Ensure Cloud Scheduler (daily 08:00 Europe/Zurich)
        run: |
          set -euo pipefail
          URI="https://${REGION}-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${PROJECT_ID}/jobs/${JOB}:run"

          if gcloud scheduler jobs describe "${SCHEDULER_JOB}" --location "${REGION}" >/dev/null 2>&1; then
            gcloud scheduler jobs update http "${SCHEDULER_JOB}" \
              --location "${REGION}" \
              --schedule "0 8 * * *" \
              --time-zone "${TIME_ZONE}" \
              --uri "${URI}" \
              --http-method POST \
              --oauth-service-account-email "${SCHEDULER_SA}"
          else
            gcloud scheduler jobs create http "${SCHEDULER_JOB}" \
              --location "${REGION}" \
              --schedule "0 8 * * *" \
              --time-zone "${TIME_ZONE}" \
              --uri "${URI}" \
              --http-method POST \
              --oauth-service-account-email "${SCHEDULER_SA}"
          fi

      - name: Run pipeline once after deploy
        run: |
          set -euo pipefail
          gcloud run jobs execute "${JOB}" --region "${REGION}"
